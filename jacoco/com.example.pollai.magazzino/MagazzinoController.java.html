<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MagazzinoController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PollAI</a> &gt; <a href="index.source.html" class="el_package">com.example.pollai.magazzino</a> &gt; <span class="el_source">MagazzinoController.java</span></div><h1>MagazzinoController.java</h1><pre class="source lang-java linenums">package com.example.pollai.magazzino;

import com.example.pollai.pollaio.Pollaio;
import com.example.pollai.utente.Utente;
import com.example.pollai.utente.UtenteController;
import com.example.pollai.utente.UtenteService;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.Optional;

@Controller
<span class="fc" id="L21">public class MagazzinoController {</span>

    @Autowired
    private MagazzinoService magazzinoService;
    @Autowired
    private UtenteService utenteService;

<span class="fc" id="L28">    private static final Logger log = LoggerFactory.getLogger(UtenteController.class);</span>


    @GetMapping(&quot;/accesso-magazzino&quot;)
    public String Magazzino(HttpSession session, Model model){
<span class="fc" id="L33">        Utente utente = getUtente(session);</span>
<span class="fc bfc" id="L34" title="All 2 branches covered.">        if(utente == null) return &quot;login&quot;;</span>

<span class="fc" id="L36">        Pollaio pollaio = utente.getPollaio();</span>
        //Se non ha galline o è nullo reinderizzalo verso configura-pollaio
<span class="pc bpc" id="L38" title="1 of 4 branches missed.">        if(pollaio == null || pollaio.getQuantity() == 0 ){</span>
<span class="fc" id="L39">            return &quot;configura-pollaio&quot;;</span>
        }

        Magazzino magazzino;
<span class="fc bfc" id="L43" title="All 2 branches covered.">        if(utente.getMagazzino() == null){</span>
<span class="fc" id="L44">            magazzino = magazzinoService.createMagazzino(utente);</span>
<span class="fc" id="L45">            log.info(&quot;Creato Magazzino&quot;);</span>
        } else{
            //Se non è il primo accesso l'utente avrà una notifica sulle sue scorte
<span class="fc" id="L48">            magazzino = utente.getMagazzino();</span>
<span class="fc" id="L49">            magazzino.setNotifica();</span>
        }
        //aggiorna il magazzino
<span class="fc" id="L52">        utente.setMagazzino(magazzino);</span>
<span class="fc" id="L53">        session.setAttribute(&quot;user&quot;, utente);</span>

<span class="fc" id="L55">        return &quot;magazzino&quot;;</span>
    }

    @PostMapping(&quot;/inserisci-farmaco&quot;)
    public String inserisciFarmaco(HttpSession session,String tipo_f, int quantita_f, HttpServletRequest request){
<span class="fc" id="L60">        Utente utente = getUtente(session);</span>
<span class="fc bfc" id="L61" title="All 2 branches covered.">        if(utente == null) return &quot;login&quot;;</span>
        // Ottieni il riferimento della pagina precedente
<span class="fc" id="L63">        String referer = request.getHeader(&quot;Referer&quot;);</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">        if(quantita_f &gt; 0) {</span>
            // Crea e aggiungi il farmaco al magazzino
<span class="fc" id="L66">            Farmaco farmaco = new Farmaco(tipo_f, quantita_f, utente.getMagazzino());</span>
<span class="fc" id="L67">            Magazzino magazzinoAggiornato = magazzinoService.addFarmaco(utente.getMagazzino(), farmaco);</span>
            // Aggiorna l'utente con il magazzino aggiornato
<span class="fc" id="L69">            utente.setMagazzino(magazzinoAggiornato);</span>
<span class="fc" id="L70">            session.setAttribute(&quot;user&quot;, utente);</span>
        }
        // Reindirizza alla pagina precedente o alla home
<span class="fc bfc" id="L73" title="All 2 branches covered.">        return &quot;redirect:&quot; + (referer != null ? referer : &quot;/&quot;);</span>
    }

    @PostMapping(&quot;/inserisci-cibo&quot;)
    public String inserisciCibo(HttpSession session,String tipo_c, int quantita_c, HttpServletRequest request){
<span class="fc" id="L78">        Utente utente = getUtente(session);</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">        if(utente == null) return &quot;login&quot;;</span>
        // Ottieni il riferimento della pagina precedente
<span class="fc" id="L81">        String referer = request.getHeader(&quot;Referer&quot;);</span>
        // Crea e aggiungi il cibo al magazzino
<span class="fc bfc" id="L83" title="All 2 branches covered.">        if(quantita_c &gt; 0) {</span>
<span class="fc" id="L84">            Cibo cibo = new Cibo(tipo_c, quantita_c, utente.getMagazzino());</span>
<span class="fc" id="L85">            Magazzino magazzinoAggiornato = magazzinoService.addCibo(utente.getMagazzino(), cibo);</span>
            // Aggiorna l'utente con il magazzino aggiornato
<span class="fc" id="L87">            utente.setMagazzino(magazzinoAggiornato);</span>
<span class="fc" id="L88">            session.setAttribute(&quot;user&quot;, utente);</span>
        }
        // Reindirizza alla pagina precedente o alla home
<span class="fc bfc" id="L91" title="All 2 branches covered.">        return &quot;redirect:&quot; + (referer != null ? referer : &quot;/&quot;);</span>
    }

    @PostMapping({&quot;/rimuovi-farmaco&quot;, &quot;/rimuovi-cibo&quot;})
    public String rimuoviElemento(HttpSession session,
                                  @RequestParam(&quot;id&quot;) Long itemId,
                                  @RequestParam(&quot;tipo&quot;) String itemType,
                                  HttpServletRequest request) {

        // Recupera l'utente dalla sessione
<span class="fc" id="L101">        Utente utente = getUtente(session);</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">        if(utente == null) return &quot;login&quot;;</span>

        // Ottieni il riferimento della pagina precedente
<span class="fc" id="L105">        String referer = request.getHeader(&quot;Referer&quot;);</span>

        // Log per tipo di elemento
<span class="fc" id="L108">        log.info(itemType + &quot; with id &quot; + itemId);</span>

        // Esegui l'operazione di rimozione in base al tipo (farmaco o cibo)
<span class="fc" id="L111">        Magazzino magazzino = null;</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (&quot;farmaco&quot;.equals(itemType)) {</span>
<span class="fc" id="L113">            magazzino = magazzinoService.removeFarmaco(utente.getMagazzino(), itemId);</span>
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">        } else if (&quot;cibo&quot;.equals(itemType)) {</span>
<span class="fc" id="L115">            magazzino = magazzinoService.removeCibo(utente.getMagazzino(), itemId);</span>
        }

        // Aggiorna l'utente con il magazzino aggiornato
<span class="fc" id="L119">        utente.setMagazzino(magazzino);</span>
<span class="fc" id="L120">        session.setAttribute(&quot;user&quot;, utente);</span>

        // Reindirizza alla pagina precedente o alla home
<span class="fc bfc" id="L123" title="All 2 branches covered.">        return &quot;redirect:&quot; + (referer != null ? referer : &quot;/&quot;);</span>
    }

    @PostMapping({&quot;/modifica-farmaco&quot;, &quot;/modifica-cibo&quot;})
    public String modificaElemento(@RequestParam(&quot;cambio&quot;) int cambio,
                                   @RequestParam(&quot;azione&quot;) String azione,
                                   @RequestParam(&quot;id&quot;) Long itemId,
                                   @RequestParam(&quot;tipo&quot;) String itemType,
                                   HttpSession session, HttpServletRequest request){
        // Recupera l'utente dalla sessione
<span class="fc" id="L133">        Utente utente = getUtente(session);</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">        if(utente == null) return &quot;login&quot;;</span>

        // Ottieni il riferimento della pagina precedente
<span class="fc" id="L137">        String referer = request.getHeader(&quot;Referer&quot;);</span>

        //aggiungere o rimuovere cambio in base all'input
<span class="fc bfc" id="L140" title="All 2 branches covered.">        cambio = Math.abs(cambio) * (azione.equals(&quot;aggiungi&quot;) ? 1 : -1);</span>

        // Esegui l'operazione di modifica in base al tipo (farmaco o cibo)
<span class="fc" id="L143">        Magazzino magazzino = null;</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">        if (&quot;farmaco&quot;.equals(itemType)) {</span>
<span class="fc" id="L145">            magazzino = magazzinoService.modificaFarmaco(utente.getMagazzino(), itemId, cambio);</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        } else if (&quot;cibo&quot;.equals(itemType)) {</span>
<span class="fc" id="L147">            magazzino = magazzinoService.modificaCibo(utente.getMagazzino(), itemId, cambio);</span>
        }

        // Aggiorna l'utente con il magazzino aggiornato
<span class="fc" id="L151">        utente.setMagazzino(magazzino);</span>
<span class="fc" id="L152">        session.setAttribute(&quot;user&quot;, utente);</span>

        // Reindirizza alla pagina precedente o alla home
<span class="fc bfc" id="L155" title="All 2 branches covered.">        return &quot;redirect:&quot; + (referer != null ? referer : &quot;/&quot;);</span>
    }

    private Utente getUtente(HttpSession session){
<span class="fc" id="L159">        Utente utente = (Utente) session.getAttribute(&quot;user&quot;);</span>

<span class="fc bfc" id="L161" title="All 2 branches covered.">        if (utente == null) {</span>
<span class="fc" id="L162">            log.warn(&quot;Nessun utente trovato in sessione.&quot;);</span>
<span class="fc" id="L163">            return null;</span>
        }

<span class="fc" id="L166">        Optional&lt;Utente&gt; optionalUtente = utenteService.getUtenteById(utente.getId());</span>

<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        if (optionalUtente.isPresent()) {</span>
<span class="fc" id="L169">            return optionalUtente.get();</span>
        } else {
<span class="nc" id="L171">            log.warn(&quot;Utente con ID {} non trovato nel database.&quot;, utente.getId());</span>
<span class="nc" id="L172">            return null;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>